<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/styles/index.css" />
    <title>영화 리뷰 - CSR</title>
  </head>
  <body>
    <!-- 빈 컨테이너 (JavaScript가 채움) -->
    <div id="root">
      <div style="display: flex; justify-content: center; align-items: center; height: 100vh;">
        <div style="text-align: center;">
          <img src="/images/loading.png" alt="로딩 중" style="width: 80px; height: 80px; animation: spin 1s linear infinite;" />
          <p style="margin-top: 20px; color: #666;">로딩 중...</p>
        </div>
      </div>
    </div>

    <style>
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
    </style>

    <script>
      // 서버 API 사용 (CORS 문제 해결)
      const API_BASE = window.location.origin;

      // 유틸리티 함수
      function buildPosterUrl(posterPath) {
        return posterPath 
          ? `https://media.themoviedb.org/t/p/w440_and_h660_face${posterPath}`
          : '/images/no_image.png';
      }

      function buildBackdropUrl(backdropPath) {
        return backdropPath
          ? `https://image.tmdb.org/t/p/w1920_and_h800_multi_faces${backdropPath}`
          : '/images/dizzy_planet.png';
      }

      function buildOriginalUrl(posterPath) {
        return posterPath
          ? `https://image.tmdb.org/t/p/original${posterPath}`
          : '/images/no_image.png';
      }

      // 홈 페이지 렌더링
      async function renderHomePage() {
        const root = document.getElementById('root');

        try {
          // 서버 API 호출: GET /
          const response = await fetch(`${API_BASE}/`);

          if (!response.ok) {
            throw new Error('API 호출 실패');
          }

          const data = await response.json();
          const movies = data.results;
          const featuredMovie = movies[0];

          // 영화 리스트 HTML 생성
          const movieListHtml = movies
            .map((movie) => {
              const posterUrl = buildPosterUrl(movie.poster_path);
              const rate = (Math.round((movie.vote_average || 0) * 10) / 10).toFixed(1);

              return `
                <li class="movie-item">
                  <a href="#" class="item" onclick="renderDetailPage(${movie.id}); return false;">
                    <img class="thumbnail" src="${posterUrl}" alt="${movie.title}" loading="lazy" />
                    <div class="item-desc">
                      <p class="rate">
                        <img src="/images/star_empty.png" class="star" />
                        <span>${rate}</span>
                      </p>
                      <strong>${movie.title}</strong>
                    </div>
                  </a>
                </li>
              `;
            })
            .join('');

          // 전체 페이지 HTML
          const html = `
            <div id="wrap">
              <header>
                <div class="background-container" style="background-image: url(${buildBackdropUrl(featuredMovie.backdrop_path)});">
                  <div class="overlay"></div>
                  <div class="top-rated-container">
                    <img src="/images/logo.png" width="117" height="20" class="logo" alt="MovieLogo" />
                    <div class="top-rated-movie">
                      <div class="rate">
                        <img src="/images/star_empty.png" width="32" height="32" />
                        <span class="text-2xl font-semibold text-yellow">${(Math.round((featuredMovie.vote_average || 0) * 10) / 10).toFixed(1)}</span>
                      </div>
                      <h1 class="text-3xl font-semibold">${featuredMovie.title}</h1>
                      <a class="primary detail" href="#" onclick="renderDetailPage(${featuredMovie.id}); return false;">자세히 보기</a>
                    </div>
                  </div>
                </div>
              </header>
              <main>
                <section class="container">
                  <h2 class="text-2xl font-bold mb-64">지금 인기 있는 영화</h2>
                  <ul class="thumbnail-list">
                    ${movieListHtml}
                  </ul>
                </section>
              </main>
              <footer class="footer">
                <p>&copy; 우아한테크코스 All Rights Reserved.</p>
                <p><img src="/images/woowacourse_logo.png" width="180" alt="우아한테크코스" /></p>
              </footer>
            </div>
          `;

          root.innerHTML = html;
        } catch (error) {
          console.error('홈 페이지 로딩 실패:', error);
          root.innerHTML = `
            <div style="text-align: center; padding: 50px;">
              <img src="/images/dizzy_planet.png" alt="오류" style="width: 200px; margin-bottom: 20px;" />
              <p style="font-size: 18px; color: #666;">영화 목록을 불러오는데 실패했습니다.</p>
              <button onclick="renderHomePage()" style="margin-top: 20px; padding: 10px 20px; cursor: pointer;">다시 시도</button>
            </div>
          `;
        }
      }

      // 상세 페이지 렌더링
      async function renderDetailPage(id) {
        const root = document.getElementById('root');

        try {
          // 서버 API 호출: GET /detail/:id
          const response = await fetch(`${API_BASE}/detail/${id}`);

          if (!response.ok) {
            throw new Error('API 호출 실패');
          }

          const movie = await response.json();
          const posterUrl = buildOriginalUrl(movie.poster_path);
          const genres = (movie.genres || []).map((g) => g.name).join(', ');
          const rating = (Math.round((movie.vote_average || 0) * 10) / 10).toFixed(1);

          const html = `
            <div id="wrap">
              <div class="modal-background active">
                <div class="modal">
                  <div class="modal-header">
                    <h1 class="modal-title">${movie.title}</h1>
                    <a href="#" onclick="renderHomePage(); return false;">
                      <img src="/images/modal_button_close.png" width="24" height="24" class="modal-close-btn" alt="Close" />
                    </a>
                  </div>

                  <div class="modal-container">
                    <img src="${posterUrl}" alt="${movie.title}" class="modal-image" />
                    <div class="modal-description">
                      <div class="movie-info-line">
                        <span class="movie-meta">${genres}</span>
                        <div class="movie-rating">
                          <img src="/images/star_filled.png" width="16" height="16" />
                          <span class="rating-value">${rating}</span>
                        </div>
                      </div>

                      <div class="overview-section">
                        <p class="overview-text">${movie.overview || '줄거리 정보가 없습니다.'}</p>
                      </div>

                      <div class="my-rating-section">
                        <div class="rating-header">
                          <span class="rating-label">내 별점</span>
                          <div class="star-rating">
                            <img src="/images/star_empty.png" width="24" height="24" alt="Star 1" />
                            <img src="/images/star_empty.png" width="24" height="24" alt="Star 2" />
                            <img src="/images/star_empty.png" width="24" height="24" alt="Star 3" />
                            <img src="/images/star_empty.png" width="24" height="24" alt="Star 4" />
                            <img src="/images/star_empty.png" width="24" height="24" alt="Star 5" />
                            <span class="rating-text">평가하기</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;

          root.innerHTML = html;
        } catch (error) {
          console.error('상세 페이지 로딩 실패:', error);
          alert('영화 정보를 불러오는데 실패했습니다.');
          renderHomePage();
        }
      }

      
      document.addEventListener('DOMContentLoaded', () => {
        renderHomePage();
      });

      
      window.renderHomePage = renderHomePage;
      window.renderDetailPage = renderDetailPage;
    </script>
  </body>
</html>

